#!/usr/bin/env node

const ipfsClient = require('ipfs-http-client')
const signale = require('signale')
const generateProfile = require('../generateProfile')

const host = 'ipfs.komputing.org' // ethdev berlin ipfs node
const ipfs = ipfsClient({ host, port: 443, protocol: 'https' })

const uploadToIpfsAndGenerateProfile = async () => {
  const folder = process.argv.length > 2 ? process.argv[2] : process.cwd()
  signale.await('uploading ' + folder)
  let result = await ipfs.addFromFs(folder, {recursive: true, pin: true}) 
    
  const remoteFolder = result[result.length - 1]
  const ipfsURL = 'ipfs://' + remoteFolder.hash
  signale.success('plugin URL', ipfsURL)

  signale.await('creation of plugin profile')
  const answers = await generateProfile()
  answers.url = ipfsURL
  
  return answers
}

uploadToIpfsAndGenerateProfile().then((result) => {
  signale.success('profile.json generated')
  signale.success(JSON.stringify(result, null, 1))
}).catch(signale.error)
